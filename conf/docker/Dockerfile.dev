FROM python:3.5.2

RUN mkdir /root/.ssh/
ADD conf/id_rsa /root/.ssh/id_rsa
RUN chmod 400 /root/.ssh/id_rsa
RUN ssh-keyscan -T 60 bitbucket.org >> /root/.ssh/known_hosts

WORKDIR /app/
ADD dependencies ./dependencies
ADD helpers ./helpers
ADD ["docker-entrypoint.sh", "Procfile", "README.md", "setup.py", "pytest.ini", "./"]
RUN apt-get update && apt-get install -y nodejs-legacy npm
RUN npm i -g bower
RUN mkdir -p r3sourcer var/log var/run var/www var/tmp
RUN pip install virtualenv
RUN virtualenv -p python3.5 venv/py3 && ln -s venv/py3/bin bin
RUN bin/pip install -r dependencies/pip_pytest.txt

# available only uwsgi port
EXPOSE 8081
