# -*- coding: utf-8 -*-
# Generated by Django 1.10.7 on 2018-06-18 12:21
from __future__ import unicode_literals

from django.db import migrations, models

from r3sourcer.apps.core.models import Role, CompanyContact
from r3sourcer.apps.core_adapter.utils import api_reverse_lazy


def migrate_dashboard(apps, schema_editor):
    CompanyContact_model = apps.get_model("core", "CompanyContact")
    DashboardModule = apps.get_model("core", "DashboardModule")
    UserDashboardModule = apps.get_model("core", "UserDashboardModule")
    ContentType = apps.get_model("contenttypes", "ContentType")

    candidate_ct, _ = ContentType.objects.get_or_create(app_label='candidate', model='candidatecontact')
    job_ct, _ = ContentType.objects.get_or_create(app_label='hr', model='job')
    company_ct, _ = ContentType.objects.get_or_create(app_label='core', model='company')
    companycontact_ct, _ = ContentType.objects.get_or_create(app_label='core', model='companycontact')
    modules = [
        DashboardModule.objects.get_or_create(
            content_type=candidate_ct,
            endpoint=api_reverse_lazy('candidate/candidatecontacts'),
            description='Open full list with candidates',
            add_label='+ Add new candidate',
        ),
        DashboardModule.objects.get_or_create(
            content_type=company_ct,
            endpoint=api_reverse_lazy('core/companies'),
            description='Open full list with clients',
            add_label='+ Add new client',
        ),
        DashboardModule.objects.get_or_create(
            content_type=companycontact_ct,
            endpoint=api_reverse_lazy('core/companycontacts'),
            description='Open full list with client contacts',
            add_label='+ Add new client contact',
        ),
        DashboardModule.objects.get_or_create(
            content_type=job_ct,
            endpoint=api_reverse_lazy('hr/jobs'),
            description='Open full list with jobs',
            add_label='+ Add new job',
        )
    ]

    company_contacts = CompanyContact_model.objects.filter(
        models.Q(contact__user__role__name=Role.ROLE_NAMES.manager) | models.Q(role=CompanyContact.MANAGER),
    ).distinct()
    for company_contact in company_contacts:
        for i, module in enumerate(modules):
            is_exists = UserDashboardModule.objects.filter(
                company_contact__contact=company_contact.contact,
                dashboard_module=module[0]
            ).exists()
            if not is_exists:
                UserDashboardModule.objects.get_or_create(
                    company_contact=company_contact,
                    dashboard_module=module[0],
                    position=i,
                )


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0039_dashboard_add_fields'),
        ('candidate', '0005_update_candidaterel'),
        ('hr', '0012_renamed_vacancy'),
        ('contenttypes', '0002_remove_content_type_name'),
    ]

    operations = [
        migrations.RunPython(migrate_dashboard, migrations.RunPython.noop)
    ]
